#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# If running the rails server then create or migrate existing database
if [ "${@: -2:1}" == "./bin/rails" ] && [ "${@: -1:1}" == "server" ]; then
  echo "Waiting for database to be ready..."
  
  # Wait for database with retries
  MAX_RETRIES=30
  RETRY_COUNT=0
  
  until ./bin/rails db:prepare 2>/dev/null; do
    RETRY_COUNT=$((RETRY_COUNT + 1))
    if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
      echo "Failed to connect to database after $MAX_RETRIES attempts"
      echo "DB_HOST: ${DB_HOST:-not set}"
      echo "Checking Rails credentials..."
      ./bin/rails runner "puts 'Credentials OK'" 2>&1 || echo "Credentials error - check RAILS_MASTER_KEY"
      exit 1
    fi
    echo "Database not ready, retrying in 2 seconds... ($RETRY_COUNT/$MAX_RETRIES)"
    sleep 2
  done
  
  echo "Database ready!"
fi

exec "${@}"
